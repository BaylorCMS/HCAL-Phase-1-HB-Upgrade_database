{% extends "qie_cards/base.html" %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block title %}Database Plots{% endblock %}
{% block plots %}class="active"{% endblock %}
{% block content %}

<div id="tester" style="width:600px;height:250px;"></div>
<script>
function getDateVal(dateStr){
    if (dateStr == undefined){
        return 0;
    }
    month = dateStr.substring(5, 7);
    day = dateStr.substring(8, 10);
    hour = dateStr.substring(11, 13);
    minute = dateStr.substring(14,16);
    return parseInt(month) * 32 + parseInt(day) + parseInt(hour) / 24.0 + parseInt(minute) / (24.0 * 60)
}
function getPassed(data, tests)
{
    console.log(data)
    console.log(tests)
    var cardDates = []
    for (var i = 0; i < tests.length; i++){
        test = tests[i]
        testDat = data[test]
        for (var card in testDat) {
            if (testDat.hasOwnProperty(card)) {
                console.log(card + " status -> " + testDat[card].state)
                if( testDat[card].state == 1 ){
                    if(cardDates.hasOwnProperty(card)) {
                        if(cardDates[card] < testDat[card].date){
                            cardDates[card] = testDat[card].date;
                        }
                    } else {
                        cardDates[card] = testDat[card].date;
                    }
                }
            }
        }
    }
    
    sortable = []
    for (var card in cardDates)
              sortable.push([card, cardDates[card]])
    sortable.sort(function(a, b){return a[1] - b[1]}) 
    total = 0;
    totCards = [];
    for (var i = 0; i < sortable.length; i++){
        card = sortable[i];
        cardDate = card[1];
        console.log(card[0] + " -> " + card[1] + " == " + cardDate);
        
        total += 1;
        totCards[cardDate] = total;
        
        console.log(totCards[cardDate])
    }
    tAxis = [];
    cAxis = [];
    for ( time in totCards ){
        tAxis.push(time);
        cAxis.push(totCards[time])
    }
    return [tAxis, cAxis]
}

function getData()
{
    tests=[110, 50]
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function ()
    {
        makePlot(xhr)
    }
    xhr.open("GET", "https://nbay11.fnal.gov/cards/media/plots/plots.json", true);
    xhr.send();
}

function makePlot(xhr)
{
    console.log(xhr.readyState)
    if (xhr.readyState == 4) {
        var data = JSON.parse(xhr.responseText);
        passedAxis = getPassed(data, tests);
        
        day = passedAxis[0] //day of the month of July
        totPass = passedAxis[1] 
        failed = [0,2,3,0,0,0,2] //number cards failed
        totFail = [0,2,5,5,5,5,7]
        max_X = Math.max.apply(null,day)+1
        max_Y = Math.max.apply(null,totPass)+3
        TESTER = document.getElementById('tester');
        traceFail = {
          x: day,
          y: totFail,
          name: "Failed",
          type: "scatter",
          fill: "tozeroy",
          line: {
            color: "Red"}
        };
        tracePass = {
          x: day,
          y: totPass,
          name: "Passed",
          type: "scatter",
          fill: "tozeroy",
          line: {
            color: "Green"}
        };
        layout = {
          title: "QIE Cards Passed/Failed",
          marker: {
            colorbar: {
              xpad: 2 //don't think I need this...
            }
          },
          showlegend: true,
          autosize: true,
          xaxis: {
            title:"Days (in July 2016)",
            range: [237, max_X]},
          yaxis: {
            title: "Number of Cards",
            range: [0, max_Y]},
          legend: {
            x: 0.2,
            y: 0.5 }};
        Plotly.plot(TESTER, [traceFail, tracePass], layout);
    }
}
getData()
</script>
{% for image in images %}
<div class="row">
	<div align="center">	
		<h2 class="title">{{image}}</h2>
	</div>
</div>

<div class="row">
	<div class="center" style="width:60%">
		<a href="media/plots/{{image}}"><img src="media/plots/{{image}}" ></a>
	</div>
</div>
{% endfor %}
{% endblock %}
